<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'>
    <title>Visit Dashboard</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 13px;
        }
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #2196F3;
            color: white;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background: #f9f9f9;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .stat-card p {
            margin: 10px 0 0;
            font-size: 32px;
            font-weight: bold;
            color: #2196F3;
        }
    </style>
</head>
<body>
    <h1>ðŸ“Š Visit Dashboard</h1>

    <div class='stats'>
        <div class='stat-card'>
            <h3>Total Visits</h3>
            <p id='total'>0</p>
        </div>
        <div class='stat-card'>
            <h3>Today</h3>
            <p id='today'>0</p>
        </div>
        <div class='stat-card'>
            <h3>This Week</h3>
            <p id='week'>0</p>
        </div>
    </div>

    <h2>Recent Visits</h2>
    <table>
        <thead>
            <tr>
                <th>Page</th>
                <th>Time</th>
                <th>Referrer</th>
                <th>Language</th>
                <th>Platform</th>
                <th>Screen</th>
                <th>TZ</th>
                <th>User Agent</th>
            </tr>
        </thead>
        <tbody id='captures'></tbody>
    </table>

    <script>
        fetch('/captures')
            .then(r => r.text())
            .then(data => {
                var lines = data.split(String.fromCharCode(10));
                var tbody = document.getElementById('captures');
                var now = Date.now() / 1000;
                var day = 86400;
                var week = 604800;
                var todayCount = 0;
                var weekCount = 0;
                var validCount = 0;

                for (var i = lines.length - 1; i >= 0; i--) {
                    var line = lines[i].trim();
                    if (!line || line.indexOf('error') === 0) continue;

                    var parts = line.split('|');
                    if (parts.length >= 5 && parts[0].indexOf('capture_') === 0) {
                        validCount++;
                        var id = parts[0];
                        var page = parts[1] || '/';
                        var ts = parts[2];
                        var referrer = parts[3] || '-';
                        var ua = parts[4] || '-';
                        var lang = parts[5] || '-';
                        var platform = parts[6] || '-';
                        var screenW = parts[7] || '?';
                        var screenH = parts[8] || '?';
                        var tz = parts[9] || '?';

                        if (ts && !isNaN(ts)) {
                            var tr = document.createElement('tr');
                            var age = now - parseInt(ts);
                            if (age < day) todayCount++;
                            if (age < week) weekCount++;

                            var timeStr = new Date(ts * 1000).toLocaleString();
                            tr.innerHTML = '<td>' + page + '</td><td>' + timeStr + '</td><td>' +
                                referrer + '</td><td>' + lang + '</td><td>' + platform + '</td><td>' +
                                screenW + 'x' + screenH + '</td><td>' + tz + '</td><td>' + ua + '</td>';
                            tbody.appendChild(tr);
                        }
                    }
                }

                document.getElementById('total').textContent = validCount;
                document.getElementById('today').textContent = todayCount;
                document.getElementById('week').textContent = weekCount;
            });
    </script>
</body>
</html>
